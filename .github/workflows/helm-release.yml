name: Helm Chart Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Lint Helm Chart
        run: |
          helm lint chart/k8snet-checker

      - name: Helm Template Test
        run: |
          helm template k8snet-checker ./chart/k8snet-checker \
            --namespace toolbox \
            --debug

  release:
    needs: lint-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update Chart version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Updating Chart version to $VERSION"
          sed -i "s/^version:.*/version: $VERSION/" chart/k8snet-checker/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" chart/k8snet-checker/Chart.yaml
          
          # æ›´æ–° values.yaml ä¸­çš„é•œåƒæ ‡ç­¾ï¼ˆä½¿ç”¨ä¸å¸¦ v å‰ç¼€çš„ç‰ˆæœ¬å·ï¼‰
          sed -i 's/tag: "latest"/tag: "'"$VERSION"'"/' chart/k8snet-checker/values.yaml
          
          # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
          echo "=== Chart.yaml ==="
          cat chart/k8snet-checker/Chart.yaml
          echo "=== values.yaml (image tags) ==="
          grep -A 2 "image:" chart/k8snet-checker/values.yaml

      - name: Create package directory
        run: |
          mkdir -p .cr-release-packages
          ls -la

      - name: Package Helm Chart
        run: |
          helm package chart/k8snet-checker -d .cr-release-packages
          ls -la .cr-release-packages/

      - name: Generate Chart README
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > .cr-release-packages/INSTALL.md << EOF
          # K8s Network Checker Helm Chart v${VERSION}
          
          ## å®‰è£…æ–¹æ³•
          
          ### æ–¹æ³• 1: ç›´æ¥ä» Release å®‰è£…
          
          \`\`\`bash
          helm install k8snet-checker \\
            https://github.com/${{ github.repository }}/releases/download/v${VERSION}/k8snet-checker-${VERSION}.tgz \\
            -n toolbox --create-namespace
          \`\`\`
          
          ### æ–¹æ³• 2: ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
          
          \`\`\`bash
          # ä¸‹è½½ Chart
          wget https://github.com/${{ github.repository }}/releases/download/v${VERSION}/k8snet-checker-${VERSION}.tgz
          
          # åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
          cat > custom-values.yaml << 'YAML'
          server:
            image:
              tag: "${VERSION}"
            env:
              logLevel: "info"
          
          client:
            image:
              tag: "${VERSION}"
            env:
              logLevel: "info"
          YAML
          
          # å®‰è£…
          helm install k8snet-checker k8snet-checker-${VERSION}.tgz \\
            -n toolbox --create-namespace \\
            -f custom-values.yaml
          \`\`\`
          
          ## å‡çº§
          
          \`\`\`bash
          helm upgrade k8snet-checker \\
            https://github.com/${{ github.repository }}/releases/download/v${VERSION}/k8snet-checker-${VERSION}.tgz \\
            -n toolbox
          \`\`\`
          
          ## éªŒè¯
          
          \`\`\`bash
          # æ£€æŸ¥ Pod çŠ¶æ€
          kubectl get pods -n toolbox -l app.kubernetes.io/name=k8snet-checker
          
          # æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
          kubectl logs -n toolbox -l app.kubernetes.io/component=server -f
          
          # æµ‹è¯• API
          kubectl port-forward -n toolbox svc/k8snet-checker-server 8080:8080
          curl http://localhost:8080/api/v1/health
          \`\`\`
          
          ## æ–‡æ¡£
          
          - [å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/v${VERSION}/chart/k8snet-checker)
          - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }})
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            .cr-release-packages/*.tgz
            .cr-release-packages/INSTALL.md
          generate_release_notes: true
          body: |
            ## Helm Chart Release v${{ steps.version.outputs.version }}
            
            ### å¿«é€Ÿå®‰è£…
            
            ```bash
            helm install k8snet-checker \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/k8snet-checker-${{ steps.version.outputs.version }}.tgz \
              -n toolbox --create-namespace
            ```
            
            ### éªŒè¯éƒ¨ç½²
            
            ```bash
            # æ£€æŸ¥ Pod çŠ¶æ€
            kubectl get pods -n toolbox -l app.kubernetes.io/name=k8snet-checker
            
            # æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
            kubectl logs -n toolbox -l app.kubernetes.io/component=server
            
            # æµ‹è¯• API
            kubectl port-forward -n toolbox svc/k8snet-checker-server 8080:8080
            curl http://localhost:8080/api/v1/health
            ```
            
            ### æ–‡æ¡£
            
            - ğŸ“– [Chart README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/chart/k8snet-checker/README.md)
            - ğŸ“¦ [å®‰è£…æŒ‡å—](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/INSTALL.md)
            - ğŸ  [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }})
            
            ### é•œåƒç‰ˆæœ¬
            
            - Server: `sgfoot/k8snet-checker-server:${{ steps.version.outputs.version }}`
            - Client: `sgfoot/k8snet-checker-client:${{ steps.version.outputs.version }}`
            
            > æ³¨æ„ï¼šé•œåƒæ ‡ç­¾ä¸åŒ…å« `v` å‰ç¼€ï¼Œä¾‹å¦‚ `1.0.0` è€Œä¸æ˜¯ `v1.0.0`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Chart Artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.version.outputs.version }}
          path: .cr-release-packages/*.tgz
          retention-days: 90
