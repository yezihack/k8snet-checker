name: Helm Chart Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - 'chart/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Lint Helm Chart
        run: |
          ct lint --target-branch main --charts chart/k8snet-checker

      - name: Helm Template Test
        run: |
          helm template k8snet-checker ./chart/k8snet-checker \
            --namespace kube-system \
            --debug

  release:
    needs: lint-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "chart_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Chart version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^version:.*/version: $VERSION/" chart/k8snet-checker/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" chart/k8snet-checker/Chart.yaml
          
          # 更新 values.yaml 中的镜像标签
          sed -i "s/tag: \"latest\"/tag: \"v$VERSION\"/" chart/k8snet-checker/values.yaml

      - name: Package Helm Chart
        run: |
          mkdir -p .cr-release-packages
          helm package chart/k8snet-checker -d .cr-release-packages

      - name: Generate Chart README
        run: |
          cat > .cr-release-packages/README.md << 'EOF'
          # K8s Network Checker Helm Chart
          
          ## 安装
          
          ```bash
          helm repo add k8snet-checker https://github.com/yezihack/k8snet-checker/releases/download/${{ steps.version.outputs.version }}
          helm repo update
          helm install k8snet-checker k8snet-checker/k8snet-checker -n kube-system
          ```
          
          ## 或直接从 Release 安装
          
          ```bash
          helm install k8snet-checker \
            https://github.com/yezihack/k8snet-checker/releases/download/${{ steps.version.outputs.version }}/k8snet-checker-${{ steps.version.outputs.version }}.tgz \
            -n kube-system
          ```
          
          ## 文档
          
          详细文档请查看: https://github.com/yezihack/k8snet-checker/tree/main/chart/k8snet-checker
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            .cr-release-packages/*.tgz
            .cr-release-packages/README.md
          generate_release_notes: true
          body: |
            ## Helm Chart Release v${{ steps.version.outputs.version }}
            
            ### 安装方法
            
            ```bash
            # 直接从 Release 安装
            helm install k8snet-checker \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/k8snet-checker-${{ steps.version.outputs.version }}.tgz \
              -n kube-system
            
            # 或使用自定义配置
            helm install k8snet-checker \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/k8snet-checker-${{ steps.version.outputs.version }}.tgz \
              -n kube-system \
              -f custom-values.yaml
            ```
            
            ### 升级方法
            
            ```bash
            helm upgrade k8snet-checker \
              https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/k8snet-checker-${{ steps.version.outputs.version }}.tgz \
              -n kube-system
            ```
            
            ### 主要变更
            
            请查看下方的自动生成的发布说明。
            
            ### 文档
            
            - [Chart README](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/chart/k8snet-checker)
            - [项目文档](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Chart to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: .cr-release-packages/*.tgz
          retention-days: 30

  # 可选: 发布到 GitHub Pages (Helm Repository)
  publish-pages:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: chart
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
